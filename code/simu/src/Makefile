# Cache-Aware vs WFD ç®—æ³•å¯¹æ¯”å®éªŒ Makefile
# 
# ä½¿ç”¨æ–¹æ³•:
#   make compile    - ç¼–è¯‘æ‰€æœ‰æ¨¡å—
#   make lib-test   - è¿è¡Œåº“ä¾èµ–æµ‹è¯•
#   make verify     - è¿è¡Œå¿«é€ŸéªŒè¯æµ‹è¯•
#   make run        - è¿è¡Œä¸»å®éªŒç¨‹åº
#   make clean      - æ¸…ç†ç¼–è¯‘æ–‡ä»¶
#   make all        - å®Œæ•´æ„å»ºå’Œæµ‹è¯•æµç¨‹

# é¡¹ç›®é…ç½®
JAVA_SRC = .
CLASS_DIR = classes
LIB_DIR = lib
MAIN_CLASS = AlgorithmComparisonExperiment
LIB_TEST_CLASS = LibraryVerification

# Javaç¼–è¯‘å™¨é…ç½®
JAVAC = javac
JAVA = java
CLASSPATH = "$(LIB_DIR)/*;$(CLASS_DIR);$(JAVA_SRC)"

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "=========================================="
	@echo "Cache-Aware vs WFD ç®—æ³•å¯¹æ¯”å®éªŒæ„å»ºç³»ç»Ÿ"
	@echo "=========================================="
	@echo "å¯ç”¨å‘½ä»¤:"
	@echo "  make compile    - ç¼–è¯‘æ‰€æœ‰Javaæ¨¡å—"
	@echo "  make lib-test   - è¿è¡Œåº“ä¾èµ–æµ‹è¯•"
	@echo "  make run        - è¿è¡Œå®Œæ•´æµç¨‹ï¼ˆç¼–è¯‘+å®éªŒ+å¯è§†åŒ–ï¼‰"
	@echo "  make picture    - ä»…ç”ŸæˆPythonå¯è§†åŒ–ç»“æœå›¾"
	@echo "  make clean      - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make all        - å®Œæ•´æ„å»ºå’Œæµ‹è¯•æµç¨‹"
	@echo "  make visualize  - å®‰è£…Pythonä¾èµ–å¹¶è¿è¡Œå¯è§†åŒ–"
	@echo ""
	@echo "æ¨èä½¿ç”¨: make run ï¼ˆä¸€é”®å®Œæˆæ‰€æœ‰ä»»åŠ¡ï¼‰"
	@echo "=========================================="

# åˆ›å»ºå¿…è¦çš„ç›®å½•
$(CLASS_DIR):
	@if not exist "$(CLASS_DIR)" mkdir "$(CLASS_DIR)"

# ç¼–è¯‘æ‰€æœ‰æ¨¡å—
compile: $(CLASS_DIR)
	@echo "=========================================="
	@echo "å¼€å§‹ç¼–è¯‘æ‰€æœ‰Javaæ¨¡å—..."
	@echo "=========================================="
	@echo "1. ç¼–è¯‘parametersæ¨¡å—..."
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) parameters/*.java
	@echo "âœ“ parametersæ¨¡å—ç¼–è¯‘å®Œæˆ"
	
	@echo "2. ç¼–è¯‘entityæ¨¡å—..."
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) entity/*.java
	@echo "âœ“ entityæ¨¡å—ç¼–è¯‘å®Œæˆ"
	
	@echo "3. ç¼–è¯‘allocationæ¨¡å—..."
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) allocation/*.java
	@echo "âœ“ allocationæ¨¡å—ç¼–è¯‘å®Œæˆ"
	
	@echo "4. ç¼–è¯‘generatoræ¨¡å—..."
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) generator/*.java
	@echo "âœ“ generatoræ¨¡å—ç¼–è¯‘å®Œæˆ"
	
	@echo "5. ç¼–è¯‘analyzeræ¨¡å—..."
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) analyzer/*.java
	@echo "âœ“ analyzeræ¨¡å—ç¼–è¯‘å®Œæˆ"
		@echo "6. ç¼–è¯‘visualizeræ¨¡å—..."
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) visualizer/*.java
	@echo "âœ“ visualizeræ¨¡å—ç¼–è¯‘å®Œæˆ"
	
	@echo "7. ç¼–è¯‘ä¸»ç¨‹åºå’Œæµ‹è¯•ç¨‹åº..."
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) $(LIB_TEST_CLASS).java
	$(JAVAC) -cp $(CLASSPATH) -d $(CLASS_DIR) $(MAIN_CLASS).java
	@echo "âœ“ ä¸»ç¨‹åºå’Œæµ‹è¯•ç¨‹åºç¼–è¯‘å®Œæˆ"
	
	@echo "=========================================="
	@echo "ğŸ‰ æ‰€æœ‰æ¨¡å—ç¼–è¯‘æˆåŠŸï¼"
	@echo "=========================================="

# è¿è¡Œåº“ä¾èµ–æµ‹è¯•
lib-test: compile
	@echo "=========================================="
	@echo "è¿è¡Œåº“ä¾èµ–æµ‹è¯•..."
	@echo "=========================================="
	$(JAVA) -cp $(CLASSPATH) $(LIB_TEST_CLASS)
	@echo "=========================================="
	@echo "âœ“ åº“ä¾èµ–æµ‹è¯•å®Œæˆ"
	@echo "=========================================="

# è¿è¡Œä¸»å®éªŒç¨‹åº
run: compile
	@echo "=========================================="
	@echo "è¿è¡Œå®Œæ•´æµç¨‹ï¼šWFD vs CacheAware_v2ç®—æ³•å¯¹æ¯”å®éªŒ..."
	@echo "=========================================="
	@echo "ğŸ¯ ä½¿ç”¨é‡å‘½ååçš„ç®—æ³•è¿›è¡Œå¯¹æ¯”"
	@echo "ğŸ“Š WFD: ç»å…¸è´Ÿè½½å‡è¡¡ç®—æ³•"
	@echo "âš¡ CacheAware_v2: å¢å¼ºç‰ˆç¼“å­˜æ„ŸçŸ¥ç®—æ³•"
	@echo "â±ï¸  é¢„è®¡è¿è¡Œæ—¶é—´: 2-5åˆ†é’Ÿï¼ˆå–å†³äºç³»ç»Ÿæ€§èƒ½ï¼‰"
	@echo "=========================================="
	$(JAVA) -cp $(CLASSPATH) $(MAIN_CLASS)
	@echo "=========================================="
	@echo "ğŸ‰ ç®—æ³•å¯¹æ¯”å®éªŒè¿è¡Œå®Œæˆï¼"
	@echo "ğŸ“ ç»“æœæ–‡ä»¶: algorithm_comparison_results.csv"
	@echo "=========================================="
	@echo ""
	@echo "ğŸ¨ è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨..."
	@$(MAKE) picture-internal
	@echo "=========================================="
	@echo "âœ… å®Œæ•´æµç¨‹æ‰§è¡ŒæˆåŠŸï¼å®éªŒæ•°æ®å’Œå›¾è¡¨éƒ½å·²ç”Ÿæˆ"
	@echo "=========================================="

# ç”ŸæˆPythonå¯è§†åŒ–ç»“æœå›¾
picture:
	@echo "=========================================="
	@echo "ç”ŸæˆPythonå¯è§†åŒ–ç»“æœå›¾ v2.0..."
	@echo "=========================================="
	@if exist "result\algorithm_comparison_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: result\algorithm_comparison_results.csv") else if exist "algorithm_comparison_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: algorithm_comparison_results.csv") else if exist "result\experiment_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: result\experiment_results.csv") else if exist "experiment_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: experiment_results.csv") else (echo "âŒ æœªæ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶ï¼Œè¯·å…ˆè¿è¡Œ: make run" && echo "   æŸ¥æ‰¾è·¯å¾„: result\algorithm_comparison_results.csv æˆ– algorithm_comparison_results.csv" && exit /b 1)
	@echo "ğŸ“Š æ£€æŸ¥Pythonç¯å¢ƒå’Œä¾èµ–..."
	@cd visualizer && pip install -q -r requirements.txt
	@echo "ğŸ¨ ä½¿ç”¨å…¨æ–°è®¾è®¡çš„å¯è§†åŒ–ç¨‹åºç”Ÿæˆå›¾è¡¨..."
	@cd visualizer && python visualize.py
	@echo "=========================================="
	@echo "âœ… å¯è§†åŒ–å›¾è¡¨ç”Ÿæˆå®Œæˆï¼"
	@echo "ç”Ÿæˆçš„æ–‡ä»¶ä½ç½®: result\"
	@if exist "result\makespan_analysis.png" echo "  âœ“ makespan_analysis.png - Makespanè¯¦ç»†åˆ†æ"
	@if exist "result\cache_hit_analysis.png" echo "  âœ“ cache_hit_analysis.png - ç¼“å­˜å‘½ä¸­ç‡è¯¦ç»†åˆ†æ"
	@if exist "result\execution_time_and_win_rate_analysis.png" echo "  âœ“ execution_time_and_win_rate_analysis.png - æ‰§è¡Œæ—¶é—´å’Œèƒœç‡åˆ†æ"	@echo "=========================================="

# å†…éƒ¨å¯è§†åŒ–ç›®æ ‡ï¼ˆä¾›runè‡ªåŠ¨è°ƒç”¨ï¼‰
picture-internal:
	@if exist "result\algorithm_comparison_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: result\algorithm_comparison_results.csv") else if exist "algorithm_comparison_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: algorithm_comparison_results.csv") else if exist "result\experiment_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: result\experiment_results.csv") else if exist "experiment_results.csv" (echo "âœ“ æ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶: experiment_results.csv") else (echo "âŒ æœªæ‰¾åˆ°å®éªŒç»“æœæ–‡ä»¶" && exit /b 1)
	@echo "ğŸ“Š æ£€æŸ¥Pythonç¯å¢ƒå’Œä¾èµ–..."
	@cd visualizer && pip install -q -r requirements.txt
	@echo "ğŸ¨ ä½¿ç”¨å…¨æ–°è®¾è®¡çš„å¯è§†åŒ–ç¨‹åºç”Ÿæˆå›¾è¡¨..."
	@cd visualizer && python visualize.py
	@echo "âœ… å¯è§†åŒ–å›¾è¡¨ç”Ÿæˆå®Œæˆï¼"
	@echo "ç”Ÿæˆçš„æ–‡ä»¶ä½ç½®: result\"
	@if exist "result\makespan_analysis.png" echo "  âœ“ makespan_analysis.png - Makespan Analysis"
	@if exist "result\cache_hit_analysis.png" echo "  âœ“ cache_hit_analysis.png - Cache Hit Rate Analysis"
	@if exist "result\execution_time_and_win_rate_analysis.png" echo "  âœ“ execution_time_and_win_rate_analysis.png - Execution Time and Win Rate Analysis"

# å®‰è£…Pythonä¾èµ–å¹¶è¿è¡Œå¯è§†åŒ–
visualize:
	@echo "=========================================="
	@echo "å®‰è£…Pythonå¯è§†åŒ–ä¾èµ–..."
	@echo "=========================================="
	cd visualizer && pip install -r requirements.txt
	@echo "âœ“ Pythonä¾èµ–å®‰è£…å®Œæˆ"
	@echo "è¿è¡Œå…¨æ–°è®¾è®¡çš„å¯è§†åŒ–ç¨‹åº v2.0..."
	cd visualizer && python visualize.py
	@echo "âœ“ å¯è§†åŒ–å®Œæˆ"

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
clean:
	@echo "=========================================="
	@echo "æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	@echo "=========================================="
	@if exist "$(CLASS_DIR)" rmdir /s /q "$(CLASS_DIR)"
	@if exist "experiment_results.csv" del "experiment_results.csv"
	@if exist "*.png" del "*.png"
	@echo "âœ“ æ¸…ç†å®Œæˆ"

# å®Œæ•´æ„å»ºå’Œæµ‹è¯•æµç¨‹
all: clean compile lib-test
	@echo "=========================================="
	@echo "ğŸ‰ å®Œæ•´æ„å»ºå’Œæµ‹è¯•æµç¨‹å®Œæˆï¼"
	@echo "=========================================="
	@echo "ç°åœ¨å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š"
	@echo "  make run        - è¿è¡Œä¸»å®éªŒ"
	@echo "  make visualize  - è¿è¡Œå¯è§†åŒ–"
	@echo "=========================================="

# æ ‡è®°ä¼ªç›®æ ‡
.PHONY: help compile lib-test run picture picture-internal visualize clean all
